# TDDæµ‹è¯•å·¥ä½œæµ Makefile
# ç®€åŒ–TDDå¼€å‘æµç¨‹çš„å¸¸ç”¨å‘½ä»¤

PYTHON = python3
PYTEST = $(PYTHON) -m pytest
TEST_DIR = .
SRC_DIR = ../src/ginkgo
TDD_HELPER = tools/tdd_helper.py

# é¢œè‰²è¾“å‡º
RED = \033[0;31m
GREEN = \033[0;32m
YELLOW = \033[1;33m
BLUE = \033[0;34m
NC = \033[0m # No Color

.PHONY: help install test tdd-red tdd-green tdd-refactor coverage clean

# é»˜è®¤ç›®æ ‡
help:
	@echo "$(BLUE)Ginkgo TDDæµ‹è¯•å·¥ä½œæµ$(NC)"
	@echo ""
	@echo "$(GREEN)TDDå¼€å‘æµç¨‹:$(NC)"
	@echo "  tdd-red MODULE=order    $(YELLOW)# Redé˜¶æ®µï¼šç¼–å†™å¤±è´¥æµ‹è¯•$(NC)"
	@echo "  tdd-green              $(YELLOW)# Greené˜¶æ®µï¼šå®ç°ä»£ç $(NC)"
	@echo "  tdd-refactor           $(YELLOW)# Refactoré˜¶æ®µï¼šé‡æ„ä¼˜åŒ–$(NC)"
	@echo ""
	@echo "$(GREEN)æµ‹è¯•å‘½ä»¤:$(NC)"
	@echo "  test                   $(YELLOW)# è¿è¡Œæ‰€æœ‰æµ‹è¯•$(NC)"
	@echo "  test-tdd               $(YELLOW)# åªè¿è¡ŒTDDæµ‹è¯•$(NC)"
	@echo "  test-integration       $(YELLOW)# åªè¿è¡Œé›†æˆæµ‹è¯•$(NC)"
	@echo "  test-unit              $(YELLOW)# åªè¿è¡Œå•å…ƒæµ‹è¯•$(NC)"
	@echo "  test-fast              $(YELLOW)# å¿«é€Ÿæµ‹è¯•ï¼ˆè·³è¿‡æ…¢æµ‹è¯•ï¼‰$(NC)"
	@echo ""
	@echo "$(GREEN)è´¨é‡æ£€æŸ¥:$(NC)"
	@echo "  coverage               $(YELLOW)# ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š$(NC)"
	@echo "  analyze-mock           $(YELLOW)# åˆ†æMockä½¿ç”¨æƒ…å†µ$(NC)"
	@echo "  metrics                $(YELLOW)# æ”¶é›†TDDåº¦é‡$(NC)"
	@echo "  quality                $(YELLOW)# ä»£ç è´¨é‡æ£€æŸ¥$(NC)"
	@echo ""
	@echo "$(GREEN)ç¯å¢ƒç®¡ç†:$(NC)"
	@echo "  install                $(YELLOW)# å®‰è£…æµ‹è¯•ä¾èµ–$(NC)"
	@echo "  clean                  $(YELLOW)# æ¸…ç†æµ‹è¯•æ–‡ä»¶$(NC)"

# å®‰è£…ä¾èµ–
install:
	@echo "$(GREEN)å®‰è£…æµ‹è¯•ä¾èµ–...$(NC)"
	pip install pytest pytest-cov pytest-mock pytest-xdist
	pip install coverage[toml]
	@echo "$(GREEN)ä¾èµ–å®‰è£…å®Œæˆ$(NC)"

# TDD Redé˜¶æ®µ
tdd-red:
	@if [ -z "$(MODULE)" ]; then \
		echo "$(RED)é”™è¯¯ï¼šè¯·æŒ‡å®šMODULEå‚æ•°$(NC)"; \
		echo "ä½¿ç”¨æ–¹æ³•: make tdd-red MODULE=order"; \
		echo "è·³è¿‡å»ºè®®: make tdd-red MODULE=order NO_SUGGESTIONS=1"; \
		exit 1; \
	fi
	@echo "$(RED)ğŸ”´ TDD Redé˜¶æ®µï¼šæ¨¡å— $(MODULE)$(NC)"
	@if [ "$(NO_SUGGESTIONS)" = "1" ]; then \
		$(PYTHON) $(TDD_HELPER) --mode red --module $(MODULE) --no-suggestions; \
	else \
		$(PYTHON) $(TDD_HELPER) --mode red --module $(MODULE); \
	fi

# TDD Greené˜¶æ®µ
tdd-green:
	@echo "$(GREEN)ğŸŸ¢ TDD Greené˜¶æ®µ$(NC)"
	$(PYTHON) $(TDD_HELPER) --mode green --run-tests

# TDD Refactoré˜¶æ®µ
tdd-refactor:
	@echo "$(BLUE)ğŸ”„ TDD Refactoré˜¶æ®µ$(NC)"
	$(PYTHON) $(TDD_HELPER) --mode refactor

# è¿è¡Œæ‰€æœ‰æµ‹è¯•
test:
	@echo "$(GREEN)è¿è¡Œæ‰€æœ‰æµ‹è¯•...$(NC)"
	$(PYTEST) $(TEST_DIR) -v

# åªè¿è¡ŒTDDæµ‹è¯•
test-tdd:
	@echo "$(GREEN)è¿è¡ŒTDDæµ‹è¯•...$(NC)"
	$(PYTEST) $(TEST_DIR) -m tdd -v

# åªè¿è¡Œé›†æˆæµ‹è¯•
test-integration:
	@echo "$(GREEN)è¿è¡Œé›†æˆæµ‹è¯•...$(NC)"
	$(PYTEST) $(TEST_DIR) -m integration -v

# åªè¿è¡Œå•å…ƒæµ‹è¯•
test-unit:
	@echo "$(GREEN)è¿è¡Œå•å…ƒæµ‹è¯•...$(NC)"
	$(PYTEST) $(TEST_DIR) -m "unit and not slow" -v

# å¿«é€Ÿæµ‹è¯•ï¼ˆè·³è¿‡æ…¢æµ‹è¯•ï¼‰
test-fast:
	@echo "$(GREEN)è¿è¡Œå¿«é€Ÿæµ‹è¯•...$(NC)"
	$(PYTEST) $(TEST_DIR) -m "not slow" -v --maxfail=3

# é£æ§ç›¸å…³æµ‹è¯•
test-risk:
	@echo "$(GREEN)è¿è¡Œé£æ§ç³»ç»Ÿæµ‹è¯•...$(NC)"
	$(PYTEST) $(TEST_DIR) -m risk_management -v

# é‡‘èç²¾åº¦æµ‹è¯•
test-financial:
	@echo "$(GREEN)è¿è¡Œé‡‘èç²¾åº¦æµ‹è¯•...$(NC)"
	$(PYTEST) $(TEST_DIR) -m financial -v

# ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
coverage:
	@echo "$(GREEN)ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š...$(NC)"
	$(PYTHON) $(TDD_HELPER) --coverage-report
	@echo "$(GREEN)è¦†ç›–ç‡æŠ¥å‘Š: test_v2/htmlcov/index.html$(NC)"

# åˆ†æMockä½¿ç”¨
analyze-mock:
	@echo "$(YELLOW)åˆ†æMockä½¿ç”¨æƒ…å†µ...$(NC)"
	$(PYTHON) $(TDD_HELPER) --analyze-mock

# æ”¶é›†TDDåº¦é‡
metrics:
	@echo "$(BLUE)æ”¶é›†TDDåº¦é‡æ•°æ®...$(NC)"
	$(PYTHON) $(TDD_HELPER) --collect-metrics

# ä»£ç è´¨é‡æ£€æŸ¥
quality:
	@echo "$(BLUE)è¿è¡Œä»£ç è´¨é‡æ£€æŸ¥...$(NC)"
	@echo "æ£€æŸ¥ä»£ç æ ¼å¼..."
	-flake8 $(SRC_DIR) --max-line-length=100 --ignore=E203,W503
	@echo "æ£€æŸ¥å¯¼å…¥æ’åº..."
	-isort --check-only $(SRC_DIR)
	@echo "æ£€æŸ¥ä»£ç é£æ ¼..."
	-black --check $(SRC_DIR)

# æ ¼å¼åŒ–ä»£ç 
format:
	@echo "$(GREEN)æ ¼å¼åŒ–ä»£ç ...$(NC)"
	black $(SRC_DIR)
	isort $(SRC_DIR)

# æ€§èƒ½æµ‹è¯•
test-performance:
	@echo "$(YELLOW)è¿è¡Œæ€§èƒ½æµ‹è¯•...$(NC)"
	$(PYTEST) $(TEST_DIR) -m "performance or slow" -v

# å†’çƒŸæµ‹è¯•ï¼ˆå¿«é€ŸéªŒè¯æ ¸å¿ƒåŠŸèƒ½ï¼‰
test-smoke:
	@echo "$(GREEN)è¿è¡Œå†’çƒŸæµ‹è¯•...$(NC)"
	$(PYTEST) $(TEST_DIR) -m smoke -v --maxfail=1

# è°ƒè¯•æ¨¡å¼è¿è¡Œæµ‹è¯•
test-debug:
	@echo "$(YELLOW)è°ƒè¯•æ¨¡å¼è¿è¡Œæµ‹è¯•...$(NC)"
	$(PYTEST) $(TEST_DIR) -v --tb=long --capture=no

# å¹¶è¡Œæµ‹è¯•ï¼ˆéœ€è¦pytest-xdistï¼‰
test-parallel:
	@echo "$(GREEN)å¹¶è¡Œè¿è¡Œæµ‹è¯•...$(NC)"
	$(PYTEST) $(TEST_DIR) -n auto -v

# æ¸…ç†æ–‡ä»¶
clean:
	@echo "$(YELLOW)æ¸…ç†æµ‹è¯•æ–‡ä»¶...$(NC)"
	find $(TEST_DIR) -name "*.pyc" -delete
	find $(TEST_DIR) -name "__pycache__" -type d -exec rm -rf {} + 2>/dev/null || true
	rm -rf $(TEST_DIR)/htmlcov
	rm -rf $(TEST_DIR)/.pytest_cache
	rm -rf $(TEST_DIR)/.coverage
	rm -f $(TEST_DIR)/tdd_metrics.json
	@echo "$(GREEN)æ¸…ç†å®Œæˆ$(NC)"

# éªŒè¯æµ‹è¯•ç¯å¢ƒ
check-env:
	@echo "$(BLUE)æ£€æŸ¥æµ‹è¯•ç¯å¢ƒ...$(NC)"
	@echo "Pythonç‰ˆæœ¬: $(shell $(PYTHON) --version)"
	@echo "Pytestç‰ˆæœ¬: $(shell $(PYTEST) --version)"
	@$(PYTHON) -c "import ginkgo; print('âœ… Ginkgoå¯å¯¼å…¥')" 2>/dev/null || echo "âŒ Ginkgoä¸å¯å¯¼å…¥"
	@echo "æµ‹è¯•æ–‡ä»¶æ•°é‡: $(shell find $(TEST_DIR) -name 'test_*.py' | wc -l)"

# ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š
report:
	@echo "$(BLUE)ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š...$(NC)"
	$(PYTEST) $(TEST_DIR) --html=test_v2/report.html --self-contained-html

# ç›‘è§†æ¨¡å¼ï¼ˆè‡ªåŠ¨é‡æ–°è¿è¡Œæµ‹è¯•ï¼‰
watch:
	@echo "$(YELLOW)ç›‘è§†æ¨¡å¼ï¼šæ–‡ä»¶å˜åŒ–æ—¶è‡ªåŠ¨è¿è¡Œæµ‹è¯•$(NC)"
	@echo "éœ€è¦å®‰è£…: pip install pytest-watch"
	ptw $(TEST_DIR) -- -v

# ç¤ºä¾‹ç”¨æ³•è¯´æ˜
example:
	@echo "$(BLUE)TDDå¼€å‘ç¤ºä¾‹æµç¨‹:$(NC)"
	@echo ""
	@echo "$(YELLOW)1. å¼€å§‹å¼€å‘æ–°åŠŸèƒ½ï¼ˆè®¢å•ç®¡ç†ï¼‰:$(NC)"
	@echo "   make tdd-red MODULE=order"
	@echo ""
	@echo "$(YELLOW)2. å®ç°ä»£ç ä½¿æµ‹è¯•é€šè¿‡:$(NC)"
	@echo "   # ç¼–å†™ src/ginkgo/trading/entities/order.py"
	@echo "   make tdd-green"
	@echo ""
	@echo "$(YELLOW)3. é‡æ„ä»£ç :$(NC)"
	@echo "   # ä¼˜åŒ–ä»£ç ç»“æ„"
	@echo "   make tdd-refactor"
	@echo ""
	@echo "$(YELLOW)4. æ£€æŸ¥è´¨é‡:$(NC)"
	@echo "   make coverage"
	@echo "   make analyze-mock"
	@echo "   make quality"