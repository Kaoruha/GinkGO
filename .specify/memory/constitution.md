<!--
Sync Impact Report:
Version change: 1.3.1 → 1.4.0
Modified principles:
- 代码注释同步原则(Code Header Synchronization) - 新增第8条核心原则
Added sections:
- 核心原则第8条: 代码注释同步原则
Removed sections: N/A
Files Updated for Consistency:
✅ updated: .specify/specs/003-default/spec.md - 已包含头部同步相关需求(FR-025, FR-031)
✅ updated: .specify/specs/003-default/plan.md - 已包含CI/CD集成检查计划
⚠ pending: .specify/templates/plan-template.md - 需要在Constitution Check中添加代码注释同步检查项
⚠ pending: .specify/templates/spec-template.md - 需要在维护需求部分考虑头部同步约束
✅ updated: .specify/templates/tasks-template.md - 已包含维护任务模板
Follow-up TODOs:
- 在CI/CD流程中添加头部准确性自动检查
- 实施代码审查时的头部同步检查清单
- 定期运行验证脚本确保头部与代码一致性
- 建立头部更新自动提醒机制
-->

# Ginkgo 项目章程

## 基本信息

- **项目名称**: Ginkgo
- **章程版本**: 1.4.0
- **制定日期**: 2025-11-03
- **最后修订**: 2025-12-29
- **项目描述**: Python量化交易库，专注于事件驱动回测、多数据库支持和完整的风险管理系统

## 核心原则

### 1. 安全与合规原则 (Security & Compliance)

**敏感文件安全检查**: 所有代码提交前必须进行敏感文件检查，确保不包含API密钥、数据库凭证、交易配置或其他敏感信息。

**具体要求**:
- 严禁在代码库中提交任何形式的明文密码、API密钥或访问令牌
- 必须使用环境变量或配置文件管理敏感信息，且敏感配置文件必须添加到.gitignore
- 提交前运行自动化扫描工具检查潜在的敏感信息泄露
- 数据库连接字符串、第三方服务凭证等必须通过安全的配置管理系统加载
- 所有开发者必须定期审查和轮换访问凭证

**理由**: 作为量化交易系统，Ginkgo处理金融数据和交易执行，安全性至关重要。敏感信息泄露可能导致资产损失和合规风险。

### 2. 架构设计原则 (Architecture Excellence)

**事件驱动优先**: 所有交易功能必须基于事件驱动架构设计，遵循PriceUpdate → Strategy → Signal → Portfolio → Order → Fill的标准流程。

**依赖注入模式**: 必须使用ServiceHub统一访问服务，通过`from ginkgo import service_hub`访问所有服务组件。为向后兼容，仍支持`from ginkgo import services`，但建议迁移到service_hub。

**职责分离**: 严格分离数据层、策略层、执行层、分析层和服务层的职责，避免跨层功能耦合。

### 3. 代码质量原则 (Code Quality)

**装饰器优化**: 必须使用`@time_logger`、`@retry`、`@cache_with_expiration`等装饰器进行性能优化和错误处理。

**类型安全**: 所有新代码必须提供类型注解，支持静态类型检查。

**错误处理最佳实践**: 严禁使用hasattr等反射机制来回避类型错误或属性检查，必须采用正确的类型检查和错误处理模式。

**具体要求**:
- 禁止使用hasattr(obj, 'attr')来判断属性是否存在，应使用正确的接口设计或类型检查
- 禁止使用try-except配合hasattr来规避类型不匹配错误
- 必须明确定义对象接口和属性，避免动态属性访问的不确定性
- 对于可选属性，应使用可选类型注解(Optional[T])和合理的默认值
- 错误处理应基于明确的异常类型，而非属性存在性检查

**命名规范**: 遵循既定的命名约定，如CRUD操作的add_/get_/update_/delete_前缀，模型继承MClickBase/MMysqlBase等。

**理由**: 使用hasattr回避错误会导致代码可读性差、调试困难、类型安全问题。正确的错误处理模式能提供更清晰的代码逻辑、更好的类型安全性和更可靠的运行时行为。

### 4. 测试原则 (Testing Excellence)

**TDD开发流程**: 新功能开发必须严格遵循TDD流程，确保每个测试用例都经过用户确认。

**具体要求**:
- **测试驱动开发**: 必须先编写失败的测试用例，然后实现最小可行代码使测试通过
- **用户确认机制**: 每个测试用例设计完成后必须等待用户确认，确保测试逻辑正确覆盖业务需求
- **分步确认流程**: 从基础逻辑方案到最终实现细节，每个阶段都需要用户确认
- **简洁沟通**: 每次测试用例讨论和确认必须控制在20行以内，保持沟通高效
- **迭代优化**: 根据用户反馈持续优化测试用例，确保测试完整性和准确性

**测试分类体系**:
- **单元测试(@pytest.mark.unit)**: 验证单个函数、方法或类的功能正确性
- **集成测试(@pytest.mark.integration)**: 验证多个组件协作的功能正确性
- **数据库测试(@pytest.mark.database)**: 验证数据持久化和查询逻辑
- **网络测试(@pytest.mark.network)**: 验证外部API调用和数据源交互
- **性能测试(@pytest.mark.performance)**: 验证系统性能指标和响应时间
- **量化测试(@pytest.mark.financial)**: 验证量化交易特有的业务逻辑和计算精度

**测试隔离原则**:
- 数据库测试必须使用独立的测试数据库，确保不影响生产数据
- 每个测试用例必须独立，不依赖其他测试的执行结果
- **真实环境测试**: 禁止使用Mock数据，所有测试必须使用真实的数据源和环境配置，确保测试结果反映实际运行情况
- **数据一致性**: 测试前确保测试数据库的数据状态与预期一致，测试后清理数据避免影响后续测试
- **网络依赖**: 测试需要真实网络连接和数据源访问，不允许使用网络Mock，确保测试覆盖真实的API调用场景

**理由**: 使用真实环境测试能够发现Mock数据可能隐藏的实际问题，如数据格式变化、API限制、网络延迟等。真实环境测试提供更高的可信度和实用性，确保代码在生产环境中的稳定性。

**理由**: 严格的TDD流程和用户确认机制能够确保代码质量，减少后期重构成本，同时保证功能实现与业务需求的一致性。简洁的沟通模式提高开发效率，测试分类体系确保覆盖全面。

### 5. 性能原则 (Performance Excellence)

**批处理优先**: 数据操作必须使用批量方法(如add_bars)而非单条操作，确保高性能。

**缓存策略**: 合理使用多级缓存(Redis + Memory + Method级别)优化性能。

**懒加载**: 动态导入和懒加载机制必须用于优化启动时间。

### 6. 任务管理原则 (Task Management Excellence)

**精简任务列表**: 任务跟踪系统必须保持简洁高效，最多显示5个活跃任务，优先移除已完成任务。

**具体要求**:
- 任务列表必须限制在最多5个，超出部分自动隐藏或归档
- 已完成的任务必须立即从活跃列表中移除，保持界面清洁
- **定期清理机制**: 必须建立定期任务清理流程，在每轮开发周期结束后主动整理任务列表
- 任务优先级必须明确，高优先级任务优先显示
- 任务状态必须实时更新，确保团队协作效率
- 长期项目应分阶段管理，每个阶段专注于有限数量的核心任务
- **用户体验优化**: 避免任务列表过长影响开发体验和团队专注度

**理由**: 过长的任务列表会降低团队专注度，增加认知负担。保持任务列表精简能够提高开发效率，减少混乱，让团队成员专注于当前最重要的工作。定期清理机制确保任务管理工具始终处于最佳状态。

### 7. 文档原则 (Documentation Excellence)

**中文优先**: 所有文档和注释必须使用中文，确保团队理解和维护的便利性。

**API文档**: 核心API必须提供详细的使用示例和参数说明。

**架构文档**: 重要组件必须有清晰的架构说明和设计理念文档。

### 8. 代码注释同步原则 (Code Header Synchronization)

**头部注释同步**: 文件代码更新后，必须同步更新文件头部的描述内容，确保头部信息准确反映代码的实际功能。

**具体要求**:
- 修改类的功能、添加/删除主要类或函数时，必须更新Role描述
- 修改模块依赖关系时，必须更新Upstream/Downstream描述
- 在代码审查过程中检查头部信息的准确性
- 定期运行验证脚本检查头部与代码的一致性
- CI/CD流程中应包含头部准确性检查
- 重构代码时必须重新评估头部描述的准确性
- 使用`scripts/generate_headers.py --force`命令批量更新头部

**理由**: 头部注释是AI理解代码结构的重要依据。如果代码变更后头部不同步，会导致AI产生错误的理解，影响代码维护和开发效率。保持头部同步能够确保大语言模型和开发者都能准确理解代码的职责和依赖关系。

## 治理结构

### 章程修订流程

1. **提案**: 任何项目成员都可以提出章程修订建议
2. **讨论**: 在团队中进行充分讨论，确保所有相关人员理解变更内容
3. **投票**: 采用多数同意原则进行表决
4. **实施**: 修订通过后更新版本号并通知所有相关人员

### 版本管理策略

- **主版本号(MAJOR)**: 向后不兼容的治理原则变更或核心原则重新定义
- **次版本号(MINOR)**: 新增原则或重大扩展现有指导原则
- **修订号(PATCH)**: 澄清说明、文字修正、非语义优化

### 合规审查

- 每季度审查章程执行情况
- 新成员加入时必须学习并确认理解章程内容
- 重要架构决策必须对照章程原则进行审查

## 执行机制

### 自动化检查

- CI/CD流水线必须集成敏感文件扫描
- 代码质量检查必须包含章程合规性验证
- 测试覆盖率必须达到设定的最低标准

### 问责机制

- 违反章程原则的代码提交必须被拒绝或要求修正
- 严重违反章程的行为将影响项目参与权限
- 优秀遵守章程的实践将被记录和推广

---

**此章程自2025年11月3日起生效，所有Ginkgo项目参与者必须严格遵守。**
