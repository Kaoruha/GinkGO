# Ginkgo回测模块功能优化TODO清单

**创建时间**: 2025-08-02  
**状态**: 待实施  
**总TODO数**: 95项  

## 📊 优先级概览

| 优先级 | 数量 | 描述 |
|--------|------|------|
| 🔥 Critical | 28 | 核心功能缺失，影响基本使用 |
| ⚠️ High | 24 | 代码质量问题，影响稳定性 |
| 📋 Medium | 26 | 易用性改进，提升用户体验 |
| 📝 Low | 17 | 扩展性和维护性优化 |

---

## 🔥 Critical Priority TODOs (28项)

### 1. 核心功能实现

#### 1.1 BasePortfolio未实现方法 (10项)
**文件**: `src/ginkgo/backtest/execution/portfolios/base_portfolio.py`

- [ ] **TODO-001**: 实现 `get_position()` 方法
  - **位置**: 行 234-237
  - **问题**: `raise NotImplemented("Portfolio should complete the get_position")`
  - **影响**: 无法获取持仓信息，核心功能缺失
  - **实施**: 实现基于code查询持仓的逻辑
  - **验收**: 能正确返回指定股票的持仓对象

- [ ] **TODO-002**: 实现 `on_price_received()` 方法  
  - **位置**: 行 250-253
  - **问题**: `raise NotImplemented("Portfolio should complete the on_price_received")`
  - **影响**: 无法处理价格更新事件
  - **实施**: 实现价格事件处理逻辑，更新持仓市值
  - **验收**: 价格更新后持仓价值能正确计算

- [ ] **TODO-003**: 实现 `on_signal()` 方法
  - **位置**: 行 268-271  
  - **问题**: `raise NotImplemented("Portfolio should complete the on_signal")`
  - **影响**: 无法处理交易信号
  - **实施**: 实现信号接收和订单生成逻辑
  - **验收**: 接收信号后能生成相应订单

- [ ] **TODO-004**: 实现 `on_order_filled()` 方法
  - **位置**: 行 284-287
  - **问题**: `raise NotImplemented("Portfolio should complete the on_order_filled")`  
  - **影响**: 无法处理订单成交
  - **实施**: 实现订单成交后的持仓和资金更新
  - **验收**: 订单成交后持仓和现金余额正确更新

- [ ] **TODO-005**: 实现 `on_order_canceled()` 方法
  - **位置**: 行 300-303
  - **问题**: `raise NotImplemented("Portfolio should complete the on_order_canceled")`
  - **影响**: 无法处理订单取消
  - **实施**: 实现订单取消后的冻结资金释放
  - **验收**: 订单取消后冻结资金正确释放

- [ ] **TODO-006**: 实现 `on_order_submitted()` 方法
  - **位置**: 行 316-319
  - **问题**: `raise NotImplemented("Portfolio should complete the on_order_submitted")`
  - **影响**: 无法处理订单提交
  - **实施**: 实现订单提交后的资金冻结逻辑
  - **验收**: 订单提交后可用资金正确减少

- [ ] **TODO-007**: 实现 `on_time_goes_by()` 方法
  - **位置**: 行 332-335
  - **问题**: `raise NotImplemented("Portfolio should complete the on_time_goes_by")`
  - **影响**: 无法处理时间推进事件
  - **实施**: 实现时间推进时的分析器激活和记录
  - **验收**: 时间推进时分析器能正确执行

- [ ] **TODO-008**: 实现 `cal_net_value()` 方法
  - **位置**: 行 410-413  
  - **问题**: `raise NotImplemented("Portfolio should complete the cal_net_value")`
  - **影响**: 无法计算净值
  - **实施**: 实现基于持仓和现金的净值计算
  - **验收**: 净值计算结果正确

- [ ] **TODO-009**: 实现 `cal_pnl()` 方法
  - **位置**: 行 430-433
  - **问题**: `raise NotImplemented("Portfolio should complete the cal_pnl")`
  - **影响**: 无法计算盈亏
  - **实施**: 实现基于成本和市值的盈亏计算
  - **验收**: 盈亏计算结果正确

- [ ] **TODO-010**: 实现 `cal_position_value()` 方法
  - **位置**: 行 446-449
  - **问题**: `raise NotImplemented("Portfolio should complete the cal_position_value")`
  - **影响**: 无法计算持仓价值
  - **实施**: 实现基于最新价格的持仓价值计算
  - **验收**: 持仓价值计算结果正确

#### 1.2 策略框架核心功能 (5项)

- [ ] **TODO-011**: BaseStrategy状态管理机制
  - **文件**: `src/ginkgo/backtest/strategy/strategies/base_strategy.py`
  - **问题**: 缺乏策略状态保存和恢复机制
  - **影响**: 策略无法在暂停后恢复
  - **实施**: 添加状态序列化和反序列化方法
  - **验收**: 策略能保存和恢复内部状态

- [ ] **TODO-012**: 策略参数优化接口
  - **文件**: `src/ginkgo/backtest/strategy/strategies/base_strategy.py`
  - **问题**: 缺乏参数优化和网格搜索支持
  - **影响**: 无法进行策略参数调优
  - **实施**: 添加参数空间定义和优化接口
  - **验收**: 能进行多参数组合的策略优化

- [ ] **TODO-013**: 策略组合管理
  - **问题**: 缺乏多策略组合和权重分配机制
  - **影响**: 无法实现策略分散化
  - **实施**: 实现策略组合和动态权重调整
  - **验收**: 能运行多策略组合并动态调整权重

- [ ] **TODO-014**: 信号中间处理层
  - **问题**: 信号生成到订单执行之间缺乏处理层
  - **影响**: 无法对信号进行过滤、合并、优先级排序
  - **实施**: 添加信号处理管道机制
  - **验收**: 能对信号进行复杂的预处理

- [ ] **TODO-015**: 动态调仓功能
  - **问题**: 缺乏基于风险或业绩的动态调仓机制
  - **影响**: 无法实现自适应仓位管理
  - **实施**: 实现基于规则的动态调仓算法
  - **验收**: 能根据市场条件自动调整仓位

#### 1.3 风控系统基础实现 (8项)

- [ ] **TODO-016**: NoRisk风控具体实现
  - **文件**: `src/ginkgo/backtest/strategy/risk_managements/no_risk.py`
  - **位置**: 行 27-30
  - **问题**: `raise NotImplemented("Risk should complete the function is_pass.")`
  - **影响**: 基础风控不可用
  - **实施**: 实现基本的通过/拒绝逻辑
  - **验收**: 风控检查能正常执行

- [ ] **TODO-017**: 仓位限制风控
  - **问题**: 缺乏单只股票和总仓位限制
  - **影响**: 无法控制仓位集中度风险
  - **实施**: 实现仓位比例和绝对数量限制
  - **验收**: 超出限制时能阻止下单

- [ ] **TODO-018**: 止损止盈自动化
  - **问题**: 缺乏自动止损止盈机制
  - **影响**: 无法自动控制单笔交易风险
  - **实施**: 实现基于价格和比例的止损止盈
  - **验收**: 达到条件时自动触发平仓

- [ ] **TODO-019**: 资金管理规则
  - **问题**: 缺乏可用资金和保证金管理
  - **影响**: 可能出现资金不足仍下单的情况
  - **实施**: 实现严格的资金可用性检查
  - **验收**: 资金不足时拒绝下单

- [ ] **TODO-020**: 市场风险预警
  - **问题**: 缺乏市场异常波动的预警机制
  - **影响**: 无法及时应对市场风险
  - **实施**: 实现基于波动率的风险预警
  - **验收**: 市场异常时能发出预警

- [ ] **TODO-021**: 流动性风险控制
  - **问题**: 缺乏成交量和流动性检查
  - **影响**: 可能在流动性不足时下大单
  - **实施**: 添加基于成交量的下单限制
  - **验收**: 流动性不足时限制下单量

- [ ] **TODO-022**: 风险指标计算
  - **问题**: 缺乏VaR、夏普比率等风险指标
  - **影响**: 无法量化评估策略风险
  - **实施**: 实现常用风险指标计算
  - **验收**: 能输出完整的风险报告

- [ ] **TODO-023**: 风险预算分配
  - **问题**: 缺乏基于风险预算的仓位分配
  - **影响**: 无法实现风险平价等高级策略
  - **实施**: 实现风险预算分配算法
  - **验收**: 能按风险预算分配仓位

#### 1.4 数据验证和一致性 (5项)

- [ ] **TODO-024**: 价格数据验证
  - **文件**: `src/ginkgo/backtest/entities/bar.py`
  - **问题**: 缺乏OHLC数据合理性检查
  - **影响**: 异常数据可能导致回测结果失真
  - **实施**: 添加价格关系验证 (O≤H, L≤C等)
  - **验收**: 异常价格数据被自动检测和处理

- [ ] **TODO-025**: 交易时间验证
  - **问题**: 缺乏交易时间段的验证
  - **影响**: 可能在非交易时间生成订单
  - **实施**: 添加交易日历和时间段检查
  - **验收**: 非交易时间的订单被拒绝

- [ ] **TODO-026**: 数据时间戳一致性
  - **问题**: 不同数据源的时间戳格式不统一
  - **影响**: 数据对齐可能出错
  - **实施**: 统一时间戳处理和验证机制
  - **验收**: 所有时间戳都采用统一格式

- [ ] **TODO-027**: 持仓数据一致性
  - **问题**: 持仓更新与资金变动缺乏原子性
  - **影响**: 可能出现数据不一致
  - **实施**: 实现事务性的持仓和资金更新
  - **验收**: 持仓和资金数据始终保持一致

- [ ] **TODO-028**: 数据快照机制
  - **问题**: 缺乏数据状态快照和回滚功能
  - **影响**: 出错时无法恢复到之前状态
  - **实施**: 实现关键时点的数据快照
  - **验收**: 能在需要时恢复到历史状态

---

## ⚠️ High Priority TODOs (24项)

### 2. 代码质量问题

#### 2.1 拼写错误修复 (8项)

- [ ] **TODO-029**: 修复NotImplemented拼写错误
  - **文件**: 多个文件中的59处
  - **问题**: 应为 `NotImplementedError` 而非 `NotImplemented`
  - **影响**: 可能导致异常处理失效
  - **实施**: 全局搜索替换 `NotImplemented` 为 `NotImplementedError`
  - **验收**: 所有异常都使用正确的类名

- [ ] **TODO-030**: 修复handlerr拼写错误
  - **文件**: `src/ginkgo/backtest/execution/engines/event_engine.py`
  - **位置**: 行152, 166, 177等
  - **问题**: handler拼写为handlerr
  - **实施**: 修正所有handler的拼写
  - **验收**: 代码中不再有拼写错误

- [ ] **TODO-031**: 修复其他拼写错误
  - **文件**: 多个文件
  - **问题**: exsist→exist, Exsits→Exists等
  - **实施**: 全面检查和修正拼写错误
  - **验收**: 通过拼写检查工具验证

#### 2.2 调试代码清理 (10项)

- [ ] **TODO-032**: 移除pdb调试代码
  - **文件**: `src/ginkgo/backtest/trading/matchmakings/sim_matchmaking.py`
  - **位置**: 行55, 312, 351
  - **问题**: 生产代码中包含pdb.set_trace()
  - **影响**: 可能导致程序在生产环境中暂停
  - **实施**: 移除所有pdb调试语句
  - **验收**: 搜索确认无残留调试代码

- [ ] **TODO-033**: 清理TODO标记
  - **文件**: 多个文件中的41个TODO
  - **问题**: 大量未处理的TODO标记
  - **影响**: 代码维护混乱
  - **实施**: 逐一处理或转换为正式issue
  - **验收**: TODO数量显著减少

- [ ] **TODO-034**: 移除硬编码控制台输出
  - **文件**: `src/ginkgo/backtest/execution/portfolios/base_portfolio.py`
  - **位置**: 行503-507
  - **问题**: 硬编码的emoji和print语句
  - **影响**: 不专业的输出格式
  - **实施**: 使用标准日志系统替代
  - **验收**: 无硬编码的控制台输出

- [ ] **TODO-035**: 统一异常处理策略
  - **文件**: 多个文件
  - **问题**: 异常处理方式不一致
  - **影响**: 错误处理不可预期
  - **实施**: 制定统一的异常处理规范
  - **验收**: 所有模块采用一致的异常处理

#### 2.3 硬编码参数提取 (6项)

- [ ] **TODO-036**: 提取时间间隔硬编码
  - **文件**: `src/ginkgo/backtest/execution/engines/historic_engine.py`
  - **位置**: 行35
  - **问题**: `_backtest_interval = datetime.timedelta(days=1)` 硬编码
  - **实施**: 提取到配置文件中
  - **验收**: 时间间隔可通过配置调整

- [ ] **TODO-037**: 提取魔法数字
  - **文件**: 多个文件
  - **问题**: 如max_waits=4, 休眠时间等魔法数字
  - **实施**: 定义常量或配置项
  - **验收**: 重要参数都有明确的命名和配置

- [ ] **TODO-038**: 提取手续费率参数
  - **文件**: `src/ginkgo/backtest/trading/matchmakings/base_matchmaking.py`
  - **问题**: 手续费计算参数硬编码
  - **实施**: 支持可配置的手续费率
  - **验收**: 手续费率可按券商灵活配置

- [ ] **TODO-039**: 提取涨跌停限制参数
  - **文件**: `src/ginkgo/backtest/trading/matchmakings/sim_matchmaking.py`
  - **位置**: 行212, 217
  - **问题**: 涨跌停比例硬编码为10%
  - **实施**: 支持不同市场的涨跌停设置
  - **验收**: 涨跌停限制可配置

---

## 📋 Medium Priority TODOs (26项)

### 3. 易用性改进

#### 3.1 API设计简化 (8项)

- [ ] **TODO-040**: 创建快速启动模板
  - **问题**: 引擎组装需要配置太多组件
  - **实施**: 提供预设的引擎配置模板
  - **验收**: 新用户能快速启动基本回测

- [ ] **TODO-041**: 简化策略创建API
  - **问题**: 策略继承和实现过于复杂
  - **实施**: 提供装饰器和函数式API
  - **验收**: 简单策略只需几行代码

- [ ] **TODO-042**: 统一CLI命令入口
  - **文件**: `src/ginkgo/client/`
  - **问题**: CLI命令分散在多个模块
  - **实施**: 创建统一的命令入口和帮助
  - **验收**: 用户能通过一个命令了解所有功能

#### 3.2 配置体系优化 (6项)

- [ ] **TODO-043**: 建立默认配置体系
  - **问题**: 缺乏合理的默认配置
  - **实施**: 为所有组件提供默认配置
  - **验收**: 无配置时系统能正常工作

- [ ] **TODO-044**: 实现配置验证
  - **问题**: 错误配置难以发现
  - **实施**: 添加配置格式和范围验证
  - **验收**: 错误配置能及时发现并提示

- [ ] **TODO-045**: 配置文件层次化
  - **问题**: 配置项缺乏分类和层次
  - **实施**: 建立分层的配置结构
  - **验收**: 配置文件结构清晰易懂

#### 3.3 文档和示例完善 (12项)

- [ ] **TODO-046**: 补充核心类文档
  - **问题**: 关键类缺少详细文档
  - **实施**: 为所有公开API添加文档字符串
  - **验收**: API文档完整准确

- [ ] **TODO-047**: 创建端到端示例
  - **问题**: 缺乏完整的使用示例
  - **实施**: 提供从数据获取到结果分析的完整示例
  - **验收**: 新用户能跟随示例完成回测

- [ ] **TODO-048**: 编写最佳实践指南
  - **问题**: 用户不知道如何正确使用
  - **实施**: 总结最佳实践和常见陷阱
  - **验收**: 用户能避免常见错误

### 4. 业务功能增强

#### 4.1 交易规则完善 (10项)

- [ ] **TODO-049**: 实现标准手续费计算
  - **问题**: 手续费计算不够准确
  - **实施**: 支持分层费率和最低收费
  - **验收**: 手续费计算与实际交易一致

- [ ] **TODO-050**: 添加分红配股处理
  - **问题**: 不支持除权除息处理
  - **实施**: 实现自动的权益调整
  - **验收**: 分红配股后持仓和价格正确调整

- [ ] **TODO-051**: 支持不同订单类型
  - **问题**: 订单类型支持有限
  - **实施**: 添加条件单、算法单等类型
  - **验收**: 支持常见的订单类型

---

## 📝 Low Priority TODOs (17项)

### 5. 扩展性和维护性

#### 5.1 架构优化 (8项)

- [ ] **TODO-052**: 解耦组件依赖关系
  - **问题**: 组件间耦合过紧
  - **实施**: 使用依赖注入和接口隔离
  - **验收**: 组件能独立测试和替换

- [ ] **TODO-053**: 实现插件机制
  - **问题**: 难以添加自定义组件
  - **实施**: 设计插件接口和注册机制
  - **验收**: 第三方能开发插件

#### 5.2 测试完善 (9项)

- [ ] **TODO-054**: 提高单元测试覆盖率
  - **问题**: 测试覆盖率不足
  - **实施**: 为核心功能添加全面测试
  - **验收**: 测试覆盖率达到80%以上

- [ ] **TODO-055**: 添加集成测试
  - **问题**: 缺乏端到端集成测试
  - **实施**: 创建完整的回测流程测试
  - **验收**: 能自动验证完整功能

---

## 📈 实施建议

### 实施顺序
1. **第一阶段 (2-3周)**: Critical Priority TODOs 1-28
2. **第二阶段 (2-3周)**: High Priority TODOs 29-52  
3. **第三阶段 (2-3周)**: Medium Priority TODOs 53-78
4. **第四阶段 (1-2周)**: Low Priority TODOs 79-95

### 验收标准
- 每个TODO完成后都要有相应的测试
- 关键功能需要有文档更新
- 向后兼容性必须保持
- 性能不能显著退化

### 风险控制
- 分批实施，每批完成后进行回归测试
- 保持主分支稳定，使用特性分支开发
- 重要变更需要代码评审
- 建立持续集成流水线

---

**总结**: 这95个TODO项将显著提升Ginkgo回测模块的功能完整性、代码质量和用户体验。建议按优先级分阶段实施，确保每个阶段都有明确的价值交付。