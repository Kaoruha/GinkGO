# 1st stage: Build Vue application
FROM node:20-alpine AS vue_builder

WORKDIR /app

# Install pnpm
RUN npm install -g pnpm

# Copy package files first for better caching
COPY web-ui/package.json web-ui/pnpm-lock.yaml ./

# Install dependencies using pnpm
RUN pnpm install --frozen-lockfile

# Copy source code
COPY web-ui/ ./

# Build the Vue app (output goes to dist/)
RUN pnpm build

# 2nd stage: Serve with nginx
FROM nginx:1.27.0-alpine AS vue_runtime

# Copy the built Vue app from the builder stage
COPY --from=vue_builder /app/dist /usr/share/nginx/html

# Copy custom nginx config if exists (build context is .., so .conf/ is correct)
COPY .conf/nginx.conf /etc/nginx/nginx.conf

# Expose the port
EXPOSE 80

# Run Nginx in foreground
CMD ["nginx", "-g", "daemon off;"]
