# API Contract: Trading Framework Enhancement
# OpenAPI 3.0 Specification

openapi: 3.0.0
info:
  title: Ginkgo Trading Framework API
  description: 现代化量化交易框架的API合约
  version: 1.0.0
  contact:
    name: Ginkgo Development Team
    email: dev@ginkgo-trading.com
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: https://api.ginkgo-trading.com/v1
    description: Production server
  - url: https://staging-api.ginkgo-trading.com/v1
    description: Staging server
  - url: http://localhost:8000/v1
    description: Local development server

tags:
  - name: Strategies
    description: 策略管理相关接口
  - name: MarketData
    description: 市场数据相关接口
  - name: Portfolios
    description: 投资组合管理接口
  - name: TradingSignals
    description: 交易信号相关接口
  - name: Performance
    description: 绩效分析接口
  - name: RiskManagement
    description: 风险管理接口

paths:
  # 策略管理接口
  /strategies:
    get:
      tags:
        - Strategies
      summary: 获取策略列表
      description: 获取所有可用策略的列表，支持分页和过滤
      operationId: listStrategies
      parameters:
        - name: page
          in: query
          description: 页码 (从0开始)
          schema:
            type: integer
            default: 0
        - name: page_size
          in: query
          description: 每页大小
          schema:
            type: integer
            default: 20
        - name: name
          in: query
          description: 策略名称过滤
          schema:
            type: string
        - name: status
          in: query
          description: 策略状态过滤
          schema:
            type: string
            enum: [active, inactive, error]
      responses:
        '200':
          description: 策略列表
          content:
            application/json:
              schema:
                type: object
                properties:
                  strategies:
                    type: array
                    items:
                      $ref: '#/components/schemas/Strategy'
                  total:
                    type: integer
                    description: 总策略数量
                  page:
                    type: integer
                    description: 当前页码
                  page_size:
                    type: integer
                    description: 每页大小
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '500':
          $ref: '#/components/responses/ServerError'

    post:
      tags:
        - Strategies
      summary: 创建新策略
      description: 基于策略配置创建新的交易策略
      operationId: createStrategy
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/StrategyConfig'
      responses:
        '201':
          description: 策略创建成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Strategy'
        '400':
          $ref: '#/components/responses/ValidationError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '500':
          $ref: '#/components/responses/ServerError'

  /strategies/{strategy_id}:
    get:
      tags:
        - Strategies
      summary: 获取策略详情
      description: 根据策略ID获取策略的详细信息
      operationId: getStrategy
      parameters:
        - name: strategy_id
          in: path
          required: true
          description: 策略ID
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: 策略详情
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Strategy'
        '404':
          $ref: '#/components/responses/NotFoundError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '500':
          $ref: '#/components/responses/ServerError'

    put:
      tags:
        - Strategies
      summary: 更新策略配置
      description: 更新指定策略的配置参数
      operationId: updateStrategy
      parameters:
        - name: strategy_id
          in: path
          required: true
          description: 策略ID
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/StrategyConfig'
      responses:
        '200':
          description: 策略更新成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Strategy'
        '400':
          $ref: '#/components/responses/ValidationError'
        '404':
          $ref: '#/components/responses/NotFoundError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '500':
          $ref: '#/components/responses/ServerError'

    delete:
      tags:
        - Strategies
      summary: 删除策略
      description: 删除指定的策略及其相关数据
      operationId: deleteStrategy
      parameters:
        - name: strategy_id
          in: path
          required: true
          description: 策略ID
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: 策略删除成功
        '404':
          $ref: '#/components/responses/NotFoundError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '500':
          $ref: '#/components/responses/ServerError'

  # 市场数据接口
  /market-data:
    get:
      tags:
        - MarketData
      summary: 获取市场数据
      description: 获取指定标的和时间段的市场数据
      operationId: getMarketData
      parameters:
        - name: symbol
          in: query
          required: true
          description: 标的代码 (e.g., "000001.SZ")
          schema:
            type: string
        - name: start_time
          in: query
          description: 开始时间
          schema:
            type: string
            format: date-time
        - name: end_time
          in: query
          description: 结束时间
          schema:
            type: string
            format: date-time
        - name: data_type
          in: query
          description: 数据类型
          schema:
            type: string
            enum: [tick, bar_1min, bar_5min, bar_15min, bar_30min, bar_1hour, bar_1day]
            default: bar_1day
        - name: limit
          in: query
          description: 返回数据数量限制
          schema:
            type: integer
            default: 1000
      responses:
        '200':
          description: 市场数据
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/MarketData'
                  total:
                    type: integer
                    description: 数据总数量
        '400':
          $ref: '#/components/responses/ValidationError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '500':
          $ref: '#/components/responses/ServerError'

  # 投资组合接口
  /portfolios:
    get:
      tags:
        - Portfolios
      summary: 获取投资组合列表
      description: 获取用户的所有投资组合
      operationId: listPortfolios
      responses:
        '200':
          description: 投资组合列表
          content:
            application/json:
              schema:
                type: object
                properties:
                  portfolios:
                    type: array
                    items:
                      $ref: '#/components/schemas/PortfolioInfo'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '500':
          $ref: '#/components/responses/ServerError'

    post:
      tags:
        - Portfolios
      summary: 创建投资组合
      description: 创建新的投资组合
      operationId: createPortfolio
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PortfolioConfig'
      responses:
        '201':
          description: 投资组合创建成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PortfolioInfo'
        '400':
          $ref: '#/components/responses/ValidationError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '500':
          $ref: '#/components/responses/ServerError'

  # 交易信号接口
  /trading-signals:
    get:
      tags:
        - TradingSignals
      summary: 获取交易信号
      description: 获取指定策略的交易信号历史
      operationId: getTradingSignals
      parameters:
        - name: strategy_id
          in: query
          description: 策略ID过滤
          schema:
            type: string
            format: uuid
        - name: symbol
          in: query
          description: 标的过滤
          schema:
            type: string
        - name: start_time
          in: query
          description: 开始时间
          schema:
            type: string
            format: date-time
        - name: end_time
          in: query
          description: 结束时间
          schema:
            type: string
            format: date-time
        - name: limit
          in: query
          description: 返回数量限制
          schema:
            type: integer
            default: 100
      responses:
        '200':
          description: 交易信号列表
          content:
            application/json:
              schema:
                type: object
                properties:
                  signals:
                    type: array
                    items:
                      $ref: '#/components/schemas/TradingSignal'
                  total:
                    type: integer
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '500':
          $ref: '#/components/responses/ServerError'

  # 绩效分析接口
  /performance:
    get:
      tags:
        - Performance
      summary: 获取策略绩效
      description: 获取指定策略的绩效分析报告
      operationId: getPerformance
      parameters:
        - name: strategy_id
          in: query
          required: true
          description: 策略ID
          schema:
            type: string
            format: uuid
        - name: period
          in: query
          description: 分析周期
          schema:
            type: string
            enum: [1d, 1w, 1m, 3m, 6m, 1y]
            default: 1m
      responses:
        '200':
          description: 绩效分析报告
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StrategyPerformance'
        '404':
          $ref: '#/components/responses/NotFoundError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '500':
          $ref: '#/components/responses/ServerError'

components:
  schemas:
    # 基础数据模型
    MarketData:
      type: object
      description: 统一市场数据结构
      required:
        - symbol
        - timestamp
        - price
        - volume
        - data_type
      properties:
        symbol:
          type: string
          description: 标准化股票代码
          example: "000001.SZ"
        timestamp:
          type: string
          format: date-time
          description: 数据时间戳
          example: "2024-01-18T10:30:00Z"
        price:
          type: number
          format: float
          description: 价格
          example: 15.68
        volume:
          type: number
          format: float
          description: 成交量
          example: 125000.0
        high:
          type: number
          format: float
          description: 最高价
          example: 15.75
        low:
          type: number
          format: float
          description: 最低价
          example: 15.62
        open:
          type: number
          format: float
          description: 开盘价
          example: 15.70
        close:
          type: number
          format: float
          description: 收盘价
          example: 15.68
        data_type:
          type: string
          enum: [tick, bar_1min, bar_5min, bar_15min, bar_30min, bar_1hour, bar_1day]
          description: 数据类型
        period:
          type: string
          description: 时间周期
        metadata:
          type: object
          description: 元数据
          additionalProperties: true

    TradingSignal:
      type: object
      description: 标准化交易信号
      required:
        - strategy_id
        - symbol
        - direction
        - strength
        - reason
      properties:
        strategy_id:
          type: string
          format: uuid
          description: 策略唯一标识
        symbol:
          type: string
          description: 交易标的
          example: "000001.SZ"
        direction:
          type: string
          enum: [long, short, close, hold]
          description: 信号方向
        strength:
          type: number
          format: float
          minimum: 0
          maximum: 1
          description: 信号强度 (0-1)
          example: 0.85
        reason:
          type: string
          description: 信号生成原因
          example: "RSI oversold with upward momentum"
        timestamp:
          type: string
          format: date-time
          description: 信号生成时间
        price:
          type: number
          format: float
          description: 建议价格
        quantity:
          type: integer
          description: 建议数量
        timeframe:
          type: string
          enum: [intraday, day, swing, position]
          description: 时间框架
        metadata:
          type: object
          description: 元数据
          additionalProperties: true

    StrategyConfig:
      type: object
      description: 策略配置参数
      required:
        - strategy_id
        - name
        - parameters
        - risk_limits
      properties:
        strategy_id:
          type: string
          description: 策略唯一标识
        name:
          type: string
          description: 策略名称
        version:
          type: string
          description: 策略版本
        parameters:
          type: object
          description: 策略参数
          additionalProperties: true
        risk_limits:
          $ref: '#/components/schemas/RiskLimits'
        data_requirements:
          type: object
          description: 数据需求
          properties:
            symbols:
              type: array
              items:
                type: string
            data_types:
              type: array
              items:
                type: string
            lookback_period:
              type: string
        created_at:
          type: string
          format: date-time
          description: 创建时间
        updated_at:
          type: string
          format: date-time
          description: 更新时间
        metadata:
          type: object
          description: 元数据
          additionalProperties: true

    RiskLimits:
      type: object
      description: 风险控制参数配置
      properties:
        max_position_ratio:
          type: number
          format: float
          minimum: 0
          maximum: 1
          default: 0.2
          description: 单股最大仓位比例
        max_total_position_ratio:
          type: number
          format: float
          minimum: 0
          maximum: 1
          default: 0.8
          description: 总仓位最大比例
        max_drawdown_limit:
          type: number
          format: float
          minimum: 0
          maximum: 1
          default: 0.15
          description: 最大回撤限制
        max_daily_loss_limit:
          type: number
          format: float
          minimum: 0
          maximum: 1
          default: 0.05
          description: 单日最大亏损限制
        max_consecutive_losses:
          type: integer
          minimum: 0
          default: 5
          description: 最大连续亏损次数
        stop_loss_ratio:
          type: number
          format: float
          minimum: 0
          maximum: 1
          default: 0.05
          description: 止损比例
        take_profit_ratio:
          type: number
          format: float
          minimum: 0
          maximum: 1
          default: 0.1
          description: 止盈比例

    Strategy:
      type: object
      description: 策略信息
      required:
        - strategy_id
        - name
        - config
        - status
      properties:
        strategy_id:
          type: string
          format: uuid
          description: 策略ID
        name:
          type: string
          description: 策略名称
        config:
          $ref: '#/components/schemas/StrategyConfig'
        status:
          type: string
          enum: [active, inactive, error]
          description: 策略状态
        created_at:
          type: string
          format: date-time
          description: 创建时间
        updated_at:
          type: string
          format: date-time
          description: 最后更新时间
        metadata:
          type: object
          description: 元数据
          additionalProperties: true

    PortfolioInfo:
      type: object
      description: 投资组合信息
      required:
        - portfolio_id
        - total_value
        - available_cash
        - positions
        - timestamp
      properties:
        portfolio_id:
          type: string
          format: uuid
          description: 投资组合ID
        total_value:
          type: number
          format: float
          description: 总资产价值
        available_cash:
          type: number
          format: float
          description: 可用现金
        positions:
          type: object
          additionalProperties:
            $ref: '#/components/schemas/Position'
          description: 持仓信息 {symbol: Position}
        total_pnl:
          type: number
          format: float
          description: 总盈亏
        daily_pnl:
          type: number
          format: float
          description: 日盈亏
        max_drawdown:
          type: number
          format: float
          description: 最大回撤
        risk_metrics:
          type: object
          description: 风险指标
        timestamp:
          type: string
          format: date-time
          description: 信息时间戳

    Position:
      type: object
      description: 持仓信息
      required:
        - symbol
        - quantity
        - avg_price
        - current_price
        - market_value
        - position_type
      properties:
        symbol:
          type: string
          description: 标的代码
        quantity:
          type: integer
          description: 持仓数量
        avg_price:
          type: number
          format: float
          description: 平均成本价
        current_price:
          type: number
          format: float
          description: 当前价格
        market_value:
          type: number
          format: float
          description: 市值
        unrealized_pnl:
          type: number
          format: float
          description: 浮动盈亏
        realized_pnl:
          type: number
          format: float
          description: 已实现盈亏
        position_type:
          type: string
          enum: [long, short]
          description: 持仓类型
        open_timestamp:
          type: string
          format: date-time
          description: 开仓时间
        last_update:
          type: string
          format: date-time
          description: 最后更新时间

    StrategyPerformance:
      type: object
      description: 策略绩效指标
      required:
        - strategy_id
        - period
        - total_return
        - sharpe_ratio
        - max_drawdown
        - win_rate
      properties:
        strategy_id:
          type: string
          format: uuid
          description: 策略ID
        period:
          type: string
          enum: [1d, 1w, 1m, 3m, 6m, 1y]
          description: 分析周期
        total_return:
          type: number
          format: float
          description: 总收益率
        annualized_return:
          type: number
          format: float
          description: 年化收益率
        sharpe_ratio:
          type: number
          format: float
          description: 夏普比率
        max_drawdown:
          type: number
          format: float
          description: 最大回撤
        win_rate:
          type: number
          format: float
          description: 胜率
        profit_factor:
          type: number
          format: float
          description: 盈利因子
        total_trades:
          type: integer
          description: 总交易次数
        profitable_trades:
          type: integer
          description: 盈利交易次数
        losing_trades:
          type: integer
          description: 亏损交易次数
        avg_trade_return:
          type: number
          format: float
          description: 平均交易收益
        volatility:
          type: number
          format: float
          description: 波动率
        calculated_at:
          type: string
          format: date-time
          description: 计算时间

    PortfolioConfig:
      type: object
      description: 投资组合配置
      required:
        - name
        - initial_capital
        - base_currency
      properties:
        name:
          type: string
          description: 投资组合名称
        initial_capital:
          type: number
          format: float
          minimum: 0
          description: 初始资金
        base_currency:
          type: string
          description: 基础货币
          example: "CNY"
        strategies:
          type: array
          items:
            type: string
            format: uuid
          description: 关联的策略ID列表
        risk_profile:
          type: string
          enum: [conservative, moderate, aggressive]
          description: 风险偏好
        created_at:
          type: string
          format: date-time
          description: 创建时间

    # 错误响应模型
    ErrorResponse:
      type: object
      required:
        - error
        - message
        - timestamp
      properties:
        error:
          type: string
          description: 错误类型
        message:
          type: string
          description: 错误详情
        timestamp:
          type: string
          format: date-time
          description: 错误发生时间
        request_id:
          type: string
          description: 请求追踪ID
        details:
          type: object
          description: 错误详细信息
          additionalProperties: true

    # 分页响应模型
    PaginatedResponse:
      type: object
      required:
        - data
        - pagination
      properties:
        data:
          type: array
          description: 数据列表
        pagination:
          type: object
          required:
            - total
            - page
            - page_size
          properties:
            total:
              type: integer
              description: 总数据量
            page:
              type: integer
              description: 当前页码
            page_size:
              type: integer
              description: 每页大小
            total_pages:
              type: integer
              description: 总页数

  responses:
    # 标准错误响应
    ValidationError:
      description: 请求参数验证失败
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'

    NotFoundError:
      description: 资源不存在
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'

    UnauthorizedError:
      description: 未授权访问
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'

    ServerError:
      description: 服务器内部错误
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'

  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT Token认证

security:
  - BearerAuth: []